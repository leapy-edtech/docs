---
title: "Integra√ß√µes"
description: "Integra√ß√µes e conex√µes do sistema de Pulsos com servi√ßos externos e internos"
---

## Vis√£o Geral

O sistema de Pulsos se integra com m√∫ltiplos servi√ßos para criar, notificar e processar pesquisas automaticamente.

```mermaid
flowchart LR
    Directus[Directus API] --> Inngest[Inngest Jobs]
    Inngest --> Resend[Resend Email]
    Inngest --> Agent[Agent WhatsApp]
    Inngest --> Supabase[(Supabase PostgreSQL)]

    Frontend[App RH Next.js] --> Directus
    Directus --> Supabase
```

---

## Integra√ß√µes Externas

### 1. Inngest (Jobs e Eventos)

**URL**: https://app.inngest.com  
**Prop√≥sito**: Orquestra√ß√£o de jobs autom√°ticos e eventos ass√≠ncronos

**15 Jobs Ativos**:

<CardGroup cols={3}>
  <Card title="Cria√ß√£o" icon="plus">
    ‚Ä¢ createPulsosJovens ‚Ä¢ createPulsosLiderancas ‚Ä¢ processaPulsos
  </Card>
  <Card title="Status" icon="rotate">
    ‚Ä¢ updateStatusParaPendentes ‚Ä¢ updateStatusParaVencidos ‚Ä¢
    updateStatusLiderancas
  </Card>
  <Card title="Notifica√ß√µes" icon="envelope">
    ‚Ä¢ sendLembreteJovens ‚Ä¢ sendLembreteLiderancas ‚Ä¢ sendLembreteRH ‚Ä¢
    sendLiberacoes (3x)
  </Card>
</CardGroup>

**Eventos Disparados**:

- `backoffice/jovem.created` - Cria 5 pulsos para jovem e lideran√ßa
- `backoffice/pulsos.change_status` - Atualiza status de pulsos
- `backoffice/pulsos_jovens/lembrete-to-jovens.send` - Envia lembretes
- `backoffice/pulsos_rh/liberacao-to-rh.send` - Notifica libera√ß√£o

<Tip>
  Consulte a [documenta√ß√£o completa de
  Jobs](/documentation/domains/pulses/jobs-inngest) para detalhes de cada job.
</Tip>

---

### 2. Resend (Email)

**URL**: https://resend.com  
**Prop√≥sito**: Envio de notifica√ß√µes e lembretes por email

**9 Templates Ativos**:

| Template                            | Uso                        | Destinat√°rio |
| ----------------------------------- | -------------------------- | ------------ |
| `pulsos-lembrete-jovens`            | Lembrete de pulso pendente | Talentos     |
| `pulsos-lembrete-liderancas`        | Lembrete de avalia√ß√£o      | Lideran√ßas   |
| `pulsos-lembrete-jovens-to-rh`      | Status de jovens           | RH           |
| `pulsos-lembrete-liderancas-to-rh`  | Status de lideran√ßas       | RH           |
| `pulsos-liberacao-jovens-to-rh`     | Novo pulso criado          | RH           |
| `pulsos-liberacao-liderancas-to-rh` | Novo pulso criado          | RH           |
| `pulsos-liberacao-rh-to-rh`         | Novo pulso de RH           | RH           |
| `pulsos-lembrete-rh-to-rh`          | Lembrete pulso RH          | RH           |
| `pulsos-notificacao-abertura`       | Pulso dispon√≠vel           | Todos        |

**Fluxo de Envio**:

```mermaid
sequenceDiagram
    participant Job as Inngest Job
    participant Event as emails/resend.send
    participant Resend as Resend API
    participant User as Destinat√°rio

    Job->>Event: Dispara evento com template e dados
    Event->>Resend: POST /emails com template_id
    Resend->>User: Entrega email
    Resend-->>Event: Confirma√ß√£o de envio
```

**Tratamento de Erros**:

- **Bounce**: Email inv√°lido ou caixa cheia
- **Retry**: 3 tentativas com exponential backoff
- **Fallback**: Notifica√ß√£o via WhatsApp (Agent System)

---

### 3. Agent System (WhatsApp)

**Prop√≥sito**: Notifica√ß√µes via WhatsApp como canal alternativo

**Quando √© usado**:

- Email bounced (n√£o entregue)
- Taxa de resposta < 30% ap√≥s 5 dias
- Lembrete final (√∫ltimo dia de prazo)

**Mensagens Enviadas**:

```
üîî Leapy: Voc√™ tem um pulso pendente!

Ol√° {{nome}}, lembre-se de responder o Pulso {{numero}} at√© {{data_vencimento}}.

Acesse: {{link}}
```

**Integra√ß√£o**:

```typescript
// Inngest dispara para Agent System
await step.run("send-whatsapp", async () => {
  await agentSystem.sendMessage({
    phone: talent.phone,
    template: "pulso-lembrete",
    data: { nome, pulso_numero, link },
  });
});
```

---

## Integra√ß√µes Internas

### Directus (Backend)

**Papel**: API REST/GraphQL para acesso aos dados

**Collections Usadas**:

- `pulsos_jovens` - Respostas dos talentos
- `Pulsos` - Avalia√ß√µes das lideran√ßas
- `pulsos_rh` - Pesquisas com RH
- `pulsos_settings` - Configura√ß√£o de perguntas
- `pulsos_schedule_settings` - Agendamento autom√°tico

**Arquitetura de Extensions**:

O Directus possui dois tipos de endpoints customizados:

#### Endpoints P√∫blicos (Uso Externo)

Acessados por **Frontend** e **Integra√ß√µes Externas** via HTTPS com autentica√ß√£o de usu√°rio.

| Categoria | Endpoints | Uso |
|-----------|-----------|-----|
| **Analytics** | `/pulsos/performance/:jovem_id`<br/>`/pulsos/efetivacao/:jovem_id` | Hist√≥rico de talentos |
| **Acesso** | `/pulsos-access/me`<br/>`/pulsos-access/questions/:account_id` | Permiss√µes e configura√ß√µes |
| **Agendamento** | `/pulsos-schedule/settings/*`<br/>`/pulsos-schedule/reschedule/*` | Configurar e reagendar |
| **Filtros** | `/pulsos-filtered/jovens`<br/>`/pulsos-filtered/liderancas` | Busca com controle de acesso |

**Exemplo de uso**:

```typescript
// Frontend chamando endpoint p√∫blico
const response = await fetch('https://backoffice.leapy.com/pulsos-access/me', {
  headers: {
    'Authorization': `Bearer ${userToken}`
  }
});
```

#### Endpoints-Workflows (Uso Interno)

Chamados **apenas por Hooks CRON** dentro do Directus. Processam dados e disparam eventos Inngest.

| Endpoint | Chamado por | Evento Disparado | Hor√°rio |
|----------|-------------|------------------|---------|
| `/pulsos/send-liberacao-pulsos-rh-to-rh` | Hook CRON | `liberacao-to-rh.send` | 8:00 |
| `/pulsos/send-liberacao-pulsos-rh-to-jovens` | Hook CRON | `liberacao-to-jovens.send` | 8:05 |
| `/pulsos/send-lembrete-pulsos-rh-to-rh` | Hook CRON | `lembrete-to-rh.send` | 8:00 |
| `/pulsos/send-lembrete` | Hook CRON | `send-lembrete-pulsos.send` | 5:00 |

**Fluxo de Automa√ß√£o**:

```mermaid
flowchart TB
    subgraph Directus[Directus Extensions]
        HOOK[Hook CRON<br/>5:00, 8:00, 8:05]
        PUBLIC[Endpoints P√∫blicos<br/>/pulsos-schedule/*<br/>/pulsos-filtered/*]
        WORKFLOW[Endpoints Workflows<br/>/pulsos/send-liberacao-*<br/>/pulsos/send-lembrete-*]
        SHARED[Shared Utils<br/>config-service<br/>date-calculator]
    end
    
    subgraph External[Acesso Externo]
        FRONTEND[Frontend Next.js]
        API_USERS[Integra√ß√µes API]
    end
    
    subgraph Events[Sistema de Eventos]
        INNGEST[Inngest API]
        JOBS[Inngest Jobs]
    end
    
    HOOK -->|"HTTP GET<br/>localhost:8055"| WORKFLOW
    WORKFLOW -->|Query| DB[(Database)]
    WORKFLOW -->|"POST<br/>inn.gs/e/KEY"| INNGEST
    INNGEST -->|Trigger| JOBS
    
    FRONTEND -->|"HTTPS<br/>User Token"| PUBLIC
    API_USERS -->|"HTTPS<br/>User Token"| PUBLIC
    PUBLIC -->|Query/Update| DB
    
    PUBLIC --> SHARED
    WORKFLOW --> SHARED
```

**Por que usar Endpoint intermedi√°rio ao inv√©s de disparar evento direto?**

| Vantagem | Descri√ß√£o |
|----------|-----------|
| **Valida√ß√£o de Dados** | Consulta banco antes de disparar evento |
| **Controle de Regras** | Aplica filtros (status, datas, contratos) |
| **Logging** | Registra quantos pulsos foram processados |
| **Testabilidade** | Pode testar via HTTP GET sem esperar CRON |
| **Dry-run** | Usar `send_event=false` para validar sem disparar |

**Endpoints CRUD padr√£o**:

```bash
# Listar pulsos
GET /items/pulsos_jovens?filter[status][_eq]=pendente

# Criar pulso
POST /items/pulsos_jovens

# Atualizar status
PATCH /items/pulsos_jovens/12345
```

<Tip>
  Para documenta√ß√£o completa dos endpoints customizados, consulte [API Reference - Endpoints Customizados](/api-reference/backoffice/pulsos-endpoints-custom).
</Tip>

---

### Supabase (Database)

**Prop√≥sito**: Armazenamento persistente de dados

**Database**: PostgreSQL 15  
**Hosted by**: Supabase

**Tables**:

- 3 collections de pulsos (jovens, lideran√ßas, RH)
- 3 collections de configura√ß√£o
- 4 views materializadas para dashboards (charts)

**Performance**:

- √çndices em campos cr√≠ticos (status, jovem_id, data_aplicacao)
- Views pr√©-calculadas para m√©tricas
- Connection pooling para escala

---

### Next.js Frontend

**App**: App RH  
**Routes**:

- `/[account]/(rh)/pulsos/*` - Gerenciamento de pulsos (RH)
- `/[account]/(talent)/pulsos-jovens/*` - Responder pulsos (Talentos)

**API Routes**:

```typescript
// app/api/pulsos/editar/route.ts
PUT /api/pulsos/editar - Editar pulsos em lote

// app/api/pulsos/send-lembrete/route.ts
POST /api/pulsos/send-lembrete - Enviar lembretes
```

**Services**:

```typescript
// src/services/pulsos.js
export async function getPulsos(filtros) {
  return await directus.request(readItems("pulsos_jovens", filtros));
}
```

---

## Webhooks do Directus

Configure webhooks em **Settings > Webhooks** para receber notifica√ß√µes:

**Eventos Dispon√≠veis**:

- `items.create` - Quando pulso √© criado
- `items.update` - Quando pulso √© atualizado (ex: respondido)
- `items.delete` - Quando pulso √© deletado

**Exemplo de Payload**:

```json
{
  "event": "items.update",
  "accountability": {
    "user": "uuid-do-usuario",
    "role": "uuid-do-role"
  },
  "payload": {
    "id": 12345,
    "status": "respondido",
    "nps_leapy": 9,
    "data_resposta": "2024-03-03T14:30:00Z"
  },
  "collection": "pulsos_jovens"
}
```

---

## Fluxo Completo de Integra√ß√£o

### Cria√ß√£o de Pulso

```mermaid
sequenceDiagram
    participant Cron
    participant Inngest
    participant Directus
    participant DB
    participant Resend

    Cron->>Inngest: Trigger createPulsosJovens (9h)
    Inngest->>DB: Query pulsos_schedule_settings
    Inngest->>DB: Query jovens ativos
    Inngest->>Directus: POST /items/pulsos_jovens
    Directus->>DB: INSERT registro
    Inngest->>Inngest: Dispara evento de notifica√ß√£o
    Inngest->>Resend: Envia email com template
    Resend-->>Destinat√°rio: Email entregue
```

### Resposta de Pulso

```mermaid
sequenceDiagram
    participant User
    participant Frontend
    participant Directus
    participant DB

    User->>Frontend: Preenche formul√°rio
    User->>Frontend: Clica "Enviar"
    Frontend->>Directus: PATCH /items/pulsos_jovens/12345
    Directus->>DB: UPDATE status, respostas, data_resposta
    DB-->>Directus: Confirma√ß√£o
    Directus-->>Frontend: Success response
    Frontend-->>User: Mensagem de confirma√ß√£o
```

---

## Monitoramento de Integra√ß√µes

### Health Checks

| Servi√ßo  | Endpoint                  | Frequ√™ncia    |
| -------- | ------------------------- | ------------- |
| Directus | `/server/health`          | A cada minuto |
| Supabase | Dashboard                 | Manual        |
| Inngest  | Dashboard > Status        | Real-time     |
| Resend   | Dashboard > Delivery Rate | Di√°rio        |

### Alertas Configurados

- **Inngest**: Taxa de erro > 10%
- **Resend**: Bounce rate > 5%
- **Directus**: Response time > 2s (p95)

---

## Pr√≥ximos Passos

<CardGroup cols={2}>
  <Card
    title="Jobs Inngest"
    icon="gear"
    href="/documentation/domains/pulses/jobs-inngest"
  >
    Detalhes dos 15 jobs
  </Card>
  <Card
    title="API Reference"
    icon="code"
    href="/api-reference/backoffice/pulsos-jovens"
  >
    Documenta√ß√£o da API
  </Card>
  <Card
    title="Modelo de Dados"
    icon="database"
    href="/documentation/domains/pulses/data-model"
  >
    Estrutura de tabelas
  </Card>
  <Card
    title="Troubleshooting"
    icon="wrench"
    href="/guides/backoffice/pulsos-troubleshooting"
  >
    Resolver problemas
  </Card>
</CardGroup>
