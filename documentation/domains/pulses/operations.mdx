---
title: "Opera√ß√µes - Pulsos"
description: "Guia t√©cnico de opera√ß√µes do sistema de Pulsos"
---

## Vis√£o Geral

Este documento cobre opera√ß√µes t√©cnicas do sistema de Pulsos, incluindo monitoramento de jobs, troubleshooting e procedimentos de manuten√ß√£o.

<Note>
  Para guias pr√°ticos de uso di√°rio, consulte:
  - [Guia de Opera√ß√µes CS/Ops](/guides/backoffice/pulsos-operacoes)
  - [Troubleshooting](/guides/backoffice/pulsos-troubleshooting)
</Note>

---

## Monitoramento de Jobs

### Dashboard do Inngest

**URL**: https://app.inngest.com

**15 Jobs Ativos** para monitorar:

<CardGroup cols={3}>
  <Card title="Cria√ß√£o" icon="plus">
    ‚Ä¢ createPulsosJovens  
    ‚Ä¢ createPulsosLiderancas  
    ‚Ä¢ processaPulsos
  </Card>
  <Card title="Status" icon="rotate">
    ‚Ä¢ updateStatusParaPendentes (4x)  
    ‚Ä¢ updateStatusParaVencidos (2x)
  </Card>
  <Card title="Notifica√ß√µes" icon="envelope">
    ‚Ä¢ sendLembretes (3x)  
    ‚Ä¢ sendLiberacoes (3x)  
    ‚Ä¢ sendLembretePulsosRhToRh
  </Card>
</CardGroup>

### M√©tricas Cr√≠ticas por Job

| Job | Success Rate | Latency M√©dia | Alerta se |
|-----|--------------|---------------|-----------|
| `createPulsosJovens` | > 95% | < 30s | Falha ou > 60s |
| `sendLembretes*` | > 98% | < 10s | Falha ou > 30s |
| `updateStatus*` | 100% | < 5s | Qualquer falha |

### Alertas Configurados

Configure alertas no Inngest para:

- ‚ö†Ô∏è **Success Rate < 95%** em qualquer job de cria√ß√£o
- ‚ö†Ô∏è **Latency > 60s** em job de cria√ß√£o
- üö® **Falha total** em job de atualiza√ß√£o de status
- üö® **> 10% bounce rate** em notifica√ß√µes

---

## Monitoramento de Email (Resend)

### Dashboard do Resend

**URL**: https://resend.com/emails

### M√©tricas Importantes

| M√©trica | Benchmark | Alerta se |
|---------|-----------|-----------|
| **Delivery Rate** | > 98% | < 95% |
| **Bounce Rate** | < 2% | > 5% |
| **Open Rate** | > 40% | < 20% |
| **Click Rate** | > 10% | < 5% |

### Tipos de Bounce

| Tipo | Causa | A√ß√£o |
|------|-------|------|
| **Hard Bounce** | Email inv√°lido | Corrigir email do talento |
| **Soft Bounce** | Caixa cheia | Esperar e reenviar |
| **Block** | Spam filter | Whitelist `noreply@leapy.com` |

**Procedimento para Bounce**:

1. Resend Dashboard > Filtrar por "Bounced"
2. Identificar emails afetados
3. No Directus, corrigir emails em `talents` table
4. Reenviar manualmente via Inngest

---

## Monitoramento de Database (Supabase)

### Queries Lentas

**Dashboard**: Supabase > Logs > Slow Queries

**Alerta se**: Query > 5s

**Queries comuns que podem ficar lentas**:

```sql
-- 1. Agrega√ß√£o de NPS (sem √≠ndice)
SELECT AVG(nps_leapy) FROM pulsos_jovens WHERE status = 'respondido';

-- 2. Join com relacionamentos profundos
SELECT pj.*, t.*, a.*, p.* 
FROM pulsos_jovens pj
JOIN talents t ON pj.jovem_id = t.id
JOIN areas a ON t.area_id = a.id
JOIN positions p ON t.position_id = p.id;

-- 3. Busca em texto (sem √≠ndice de texto completo)
SELECT * FROM pulsos_jovens 
WHERE feedback_para_leapy ILIKE '%plataforma%';
```

**Otimiza√ß√µes**:

1. Usar views materializadas (`chart_*`)
2. Adicionar √≠ndices em campos frequentemente filtrados
3. Limitar resultados (pagina√ß√£o)

---

## Procedimentos de Manuten√ß√£o

### 1. Reprocessar Pulsos em Lote

**Quando usar**: Bug foi corrigido e √© necess√°rio reprocessar pulsos afetados.

**Procedimento**:

```bash
# 1. Identificar pulsos afetados
SELECT id FROM pulsos_jovens 
WHERE pulso = 3 
  AND status = 'agendado' 
  AND data_aplicacao < CURRENT_DATE;

# 2. Disparar evento Inngest para cada pulso
curl -X POST "https://api.inngest.com/v1/events" \
  -H "Authorization: Bearer INNGEST_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "name": "backoffice/pulsos-jovens.update-to-pendente",
    "data": {
      "pulso_ids": [12345, 12346, 12347]
    }
  }'
```

<Warning>
  Sempre teste com 1-2 pulsos antes de reprocessar em lote.
</Warning>

---

### 2. Limpar Pulsos Duplicados

**Quando usar**: Bug criou pulsos duplicados para o mesmo jovem/pulso.

**Diagn√≥stico**:

```sql
-- Identificar duplicatas
SELECT jovem_id, pulso, COUNT(*)
FROM pulsos_jovens
GROUP BY jovem_id, pulso
HAVING COUNT(*) > 1;
```

**Corre√ß√£o**:

```sql
-- Manter apenas o mais recente, deletar duplicatas
DELETE FROM pulsos_jovens
WHERE id IN (
  SELECT id FROM (
    SELECT id,
      ROW_NUMBER() OVER (
        PARTITION BY jovem_id, pulso 
        ORDER BY created_at DESC
      ) as rn
    FROM pulsos_jovens
  ) t
  WHERE rn > 1
);
```

**Preven√ß√£o**:

```sql
-- Adicionar constraint unique
CREATE UNIQUE INDEX idx_pulsos_jovens_unique
ON pulsos_jovens(jovem_id, pulso)
WHERE status != 'vencido';
```

---

### 3. Recalcular Views Materializadas

**Quando usar**: Dados foram corrigidos manualmente e views precisam ser atualizadas.

**Procedimento**:

```sql
-- Refresh view
REFRESH MATERIALIZED VIEW chart_nps_pulsos_jovens;
REFRESH MATERIALIZED VIEW chart_nps_pulsos_liderancas;
REFRESH MATERIALIZED VIEW chart_satisfacao_empresa_por_pulsos;
REFRESH MATERIALIZED VIEW chart_satisfacao_leapy_por_pulsos;
```

**Automa√ß√£o**: Views s√£o atualizadas automaticamente a cada 1 hora.

---

## Backup e Recovery

### Backup de Dados

**Frequ√™ncia**: Di√°rio (autom√°tico via Supabase)

**Reten√ß√£o**: 7 dias

**Localiza√ß√£o**: Supabase Dashboard > Settings > Backups

### Recovery de Pulso Deletado

**Procedimento**:

1. Identificar timestamp da dele√ß√£o
2. Acessar backup mais recente antes da dele√ß√£o
3. Restaurar registro espec√≠fico:

```sql
-- No backup
SELECT * FROM pulsos_jovens WHERE id = 12345;

-- No banco atual
INSERT INTO pulsos_jovens (id, jovem_id, pulso, status, ...)
VALUES (12345, 789, 3, 'respondido', ...);
```

<Warning>
  Recovery manual deve ser √∫ltimo recurso. Sempre valide integridade dos dados ap√≥s restore.
</Warning>

---

## Observabilidade

### Logs Estruturados

**Onde encontrar**:

| Sistema | URL | O que ver |
|---------|-----|-----------|
| **Inngest** | app.inngest.com | Execu√ß√£o de jobs, eventos, erros |
| **Resend** | resend.com/emails | Status de envio de emails |
| **Supabase** | app.supabase.com | Queries, slow queries, conex√µes |
| **Directus** | backoffice.leapy.com/admin | Atividades de usu√°rios |

### Queries √öteis para Debugging

```sql
-- Pulsos criados hoje
SELECT COUNT(*) FROM pulsos_jovens 
WHERE DATE(created_at) = CURRENT_DATE;

-- Pulsos com status inconsistente
SELECT id, status, data_aplicacao, data_vencimento, data_resposta
FROM pulsos_jovens
WHERE (status = 'respondido' AND data_resposta IS NULL)
   OR (status = 'pendente' AND data_vencimento < NOW())
   OR (status = 'agendado' AND data_aplicacao < NOW());

-- Taxa de resposta hoje
SELECT 
  status,
  COUNT(*) as quantidade,
  ROUND(COUNT(*)::numeric / SUM(COUNT(*)) OVER () * 100, 2) as percentual
FROM pulsos_jovens
WHERE pulso = 3
GROUP BY status;
```

---

## Runbooks

### Runbook 1: Pulsos N√£o Criados

**Sintoma**: √â dia de cria√ß√£o mas nenhum pulso foi criado.

**Diagn√≥stico**:

1. Verificar `pulsos_schedule_settings`:
   ```sql
   SELECT * FROM pulsos_schedule_settings 
   WHERE profile = 'jovens' AND enabled = true;
   ```

2. Verificar logs do job `createPulsosJovens` no Inngest

3. Verificar se h√° jovens ativos:
   ```sql
   SELECT COUNT(*) FROM talents WHERE status = 'active';
   ```

**Solu√ß√£o**: Ver [Troubleshooting completo](/guides/backoffice/pulsos-troubleshooting)

---

### Runbook 2: Email N√£o Enviado

**Sintoma**: Pulso criado mas talento n√£o recebeu email.

**Diagn√≥stico**:

1. Verificar se evento foi disparado (Inngest Events)
2. Verificar se job rodou (Inngest Runs)
3. Verificar status no Resend (Dashboard)
4. Verificar se email do talento est√° correto (Directus)

**Solu√ß√£o**:

- Se bounced: Corrigir email
- Se n√£o disparado: Reenviar via Inngest
- Se travado: Cancelar e reexecutar job

---

### Runbook 3: Job Travado

**Sintoma**: Job em "Running" por > 5min.

**Diagn√≥stico**:

1. Inngest > Functions > [Job] > Runs
2. Ver qual step est√° travado
3. Ver logs do step

**Solu√ß√£o**:

1. Cancelar job manualmente (bot√£o "Cancel")
2. Investigar causa (query lenta? API timeout?)
3. Corrigir problema
4. Re-executar manualmente

---

## SLAs e Performance

### SLAs Internos

| Opera√ß√£o | SLA | Medi√ß√£o |
|----------|-----|---------|
| **Cria√ß√£o de pulso** | < 1min por pulso | Latency do job |
| **Envio de email** | < 30s | Resend delivery time |
| **Atualiza√ß√£o de status** | < 5s | Database query time |
| **C√°lculo de m√©tricas** | < 10s | View refresh time |

### Performance Targets

| M√©trica | Target | Atual (Baseline) |
|---------|--------|------------------|
| API Response Time (p95) | < 2s | 1.2s |
| Job Success Rate | > 99% | 98.5% |
| Email Delivery Rate | > 98% | 97.8% |
| Database Slow Queries | < 1% | 0.5% |

---

## Pr√≥ximos Passos

<CardGroup cols={2}>
  <Card title="Troubleshooting" icon="wrench" href="/guides/backoffice/pulsos-troubleshooting">
    Resolver problemas espec√≠ficos
  </Card>
  <Card title="Jobs Inngest" icon="gear" href="/documentation/domains/pulses/jobs-inngest">
    Detalhes t√©cnicos dos jobs
  </Card>
  <Card title="Manual T√©cnico" icon="book" href="/guides/backoffice/pulsos-manual-tecnico">
    Guia para desenvolvedores
  </Card>
  <Card title="Integra√ß√µes" icon="plug" href="/documentation/domains/pulses/integrations">
    Servi√ßos externos
  </Card>
</CardGroup>
