---
title: "Troubleshooting: Pulsos"
description: "Guia para diagnosticar e resolver problemas t√©cnicos no sistema de Pulsos"
---

## Vis√£o Geral

Este guia ajuda a diagnosticar e resolver problemas t√©cnicos no sistema de Pulsos. Organizado por sintoma ‚Üí diagn√≥stico ‚Üí solu√ß√£o.

<Note>
  Para opera√ß√µes rotineiras, consulte o [Guia de Opera√ß√µes](/guides/backoffice/pulsos-operacoes).
</Note>

---

## Problemas de Cria√ß√£o

### Pulsos n√£o foram criados na data esperada

**Sintoma:** Job de cria√ß√£o deveria ter rodado, mas nenhum pulso foi criado.

**Diagn√≥stico:**

<Steps>
  <Step title="Verificar Agendamento">
    Acesse Directus > `pulsos_schedule_settings`
    
    ```sql
    SELECT * FROM pulsos_schedule_settings
    WHERE account_id = 'uuid-da-empresa'
      AND profile = 'jovens';
    ```
    
    Verifique:
    - `enabled` = `true`?
    - `next_pulso_date` est√° correto?
    - `cadence_unit` e `cadence_interval` fazem sentido?
  </Step>
  
  <Step title="Verificar Logs do Job">
    Inngest Dashboard > Functions > `createPulsosJovens` > Runs
    
    Filtrar por data esperada e verificar:
    - Job executou?
    - Qual foi o resultado?
    - H√° erro nos logs?
  </Step>
  
  <Step title="Verificar Talentos Ativos">
    ```sql
    SELECT COUNT(*) FROM talents
    WHERE account_id = 'uuid-da-empresa'
      AND status = 'active';
    ```
    
    Se retornar 0, n√£o h√° talentos para criar pulsos.
  </Step>
</Steps>

**Solu√ß√µes:**

| Causa | Solu√ß√£o |
|-------|---------|
| `enabled: false` | Ativar: `UPDATE pulsos_schedule_settings SET enabled = true WHERE id = 'uuid'` |
| Data incorreta | Corrigir: `UPDATE pulsos_schedule_settings SET next_pulso_date = '2024-04-01' WHERE id = 'uuid'` |
| Job falhou | Ver logs, corrigir erro, re-executar manualmente |
| Sem talentos ativos | Verificar cadastro de talentos |

---

### Pulsos criados mas status est√° "agendado"

**Sintoma:** Pulsos existem na tabela mas n√£o aparecem para os usu√°rios (status = `agendado`).

**Diagn√≥stico:**

```sql
SELECT id, jovem_id, status, data_aplicacao, data_vencimento
FROM pulsos_jovens
WHERE status = 'agendado'
  AND data_aplicacao < NOW();
```

Se retornar registros, o job de atualiza√ß√£o de status n√£o rodou.

**Solu√ß√£o:**

1. **Verificar job**: Inngest > `updateStatusPulsosJovensParaPendentes`
2. **Executar manualmente**:

```json
{
  "name": "backoffice/pulsos-jovens.update-to-pendente",
  "data": {
    "pulso_ids": [12345, 12346, 12347]
  }
}
```

3. **Atualizar diretamente** (se urgente):

```sql
UPDATE pulsos_jovens
SET status = 'pendente'
WHERE status = 'agendado'
  AND data_aplicacao <= NOW();
```

---

## Problemas de Notifica√ß√£o

### Email n√£o foi enviado

**Sintoma:** Pulso criado e status correto, mas talento n√£o recebeu email.

**Diagn√≥stico:**

<Steps>
  <Step title="Verificar Evento Inngest">
    Inngest > Events > Buscar:
    ```
    Event: backoffice/pulsos_jovens/lembrete-to-jovens.send
    ```
    
    Evento foi disparado?
  </Step>
  
  <Step title="Verificar Job de Email">
    Inngest > `sendPulsosLembretetoJovens` > Runs
    
    - Job executou?
    - Status: Success ou Failed?
    - Payload correto?
  </Step>
  
  <Step title="Verificar Resend">
    Dashboard do Resend: https://resend.com/emails
    
    - Email aparece l√°?
    - Status: Delivered / Bounced / Queued?
    - Se bounced: motivo?
  </Step>
  
  <Step title="Verificar Email do Destinat√°rio">
    ```sql
    SELECT email FROM talents WHERE id = 789;
    ```
    
    Email est√° correto? Formato v√°lido?
  </Step>
</Steps>

**Solu√ß√µes:**

| Causa | Solu√ß√£o |
|-------|---------|
| Evento n√£o disparado | Disparar manualmente via Inngest Dashboard |
| Job falhou | Ver erro nos logs, corrigir, re-executar |
| Email bounced | Atualizar email do talento, reenviar |
| Email em spam | Orientar usu√°rio a verificar spam, whitelist `noreply@leapy.com` |
| Template n√£o encontrado | Verificar se template existe no Resend |

### Lembrete enviado m√∫ltiplas vezes

**Sintoma:** Talento recebeu 3-4 emails de lembrete no mesmo dia.

**Diagn√≥stico:**

Inngest > `sendPulsosLembretetoJovens` > Runs

Filtrar por data e verificar:
- Quantas execu√ß√µes ocorreram?
- Mesmo `pulso_id` foi processado m√∫ltiplas vezes?

**Causas Poss√≠veis:**

1. **Job retriggered manualmente** m√∫ltiplas vezes
2. **Retries autom√°ticos** por falha tempor√°ria
3. **Bug** no c√≥digo de envio

**Solu√ß√£o:**

- Se foi retrigger manual: n√£o h√° problema, evitar no futuro
- Se foi retry: investigar causa da falha inicial
- Se foi bug: reportar ao time de dev

---

## Problemas de Status

### Status n√£o atualiza para "vencido"

**Sintoma:** Prazo passou mas pulso ainda est√° "pendente".

**Diagn√≥stico:**

```sql
SELECT id, status, data_vencimento
FROM pulsos_jovens
WHERE status = 'pendente'
  AND data_vencimento < NOW();
```

Se retornar registros, o job de vencimento n√£o est√° rodando.

**Solu√ß√£o:**

1. **Verificar cron job**: Inngest > `updateStatusPulsosJovensParaVencidos`
2. **Verificar agendamento**: Deve rodar a cada hora
3. **Executar manualmente**:

```json
{
  "name": "backoffice/pulsos-jovens.update-to-vencidos",
  "data": {
    "pulso_ids": [12345, 12346]
  }
}
```

4. **Hotfix** (se urgente):

```sql
UPDATE pulsos_jovens
SET status = 'vencido'
WHERE status = 'pendente'
  AND data_vencimento < NOW();
```

---

### Pulso "respondido" mas sem `data_resposta`

**Sintoma:** Inconsist√™ncia: `status = 'respondido'` mas `data_resposta = NULL`.

**Diagn√≥stico:**

```sql
SELECT id, jovem_id, status, data_resposta
FROM pulsos_jovens
WHERE status = 'respondido'
  AND data_resposta IS NULL;
```

**Solu√ß√£o:**

Corrigir manualmente:

```sql
UPDATE pulsos_jovens
SET data_resposta = updated_at
WHERE status = 'respondido'
  AND data_resposta IS NULL;
```

<Warning>
  Isso √© um bug. Reporte ao time de desenvolvimento com IDs afetados.
</Warning>

---

## Problemas de Performance

### Dashboard demora para carregar

**Sintoma:** P√°gina de pulsos leva > 10s para carregar.

**Diagn√≥stico:**

<Steps>
  <Step title="Ver Queries Lentas">
    Supabase Dashboard > Logs > Slow Queries
    
    Identifique queries > 5s relacionadas a pulsos.
  </Step>
  
  <Step title="Verificar Quantidade de Dados">
    ```sql
    SELECT COUNT(*) FROM pulsos_jovens;
    ```
    
    Se > 100.000: pode precisar de otimiza√ß√£o
  </Step>
  
  <Step title="Verificar Indexes">
    ```sql
    SELECT indexname, indexdef
    FROM pg_indexes
    WHERE tablename = 'pulsos_jovens';
    ```
  </Step>
</Steps>

**Solu√ß√µes:**

1. **Adicionar √≠ndices** (se faltando):

```sql
CREATE INDEX idx_pulsos_jovens_status ON pulsos_jovens(status);
CREATE INDEX idx_pulsos_jovens_jovem_id ON pulsos_jovens(jovem_id);
CREATE INDEX idx_pulsos_jovens_pulso ON pulsos_jovens(pulso);
CREATE INDEX idx_pulsos_jovens_data_aplicacao ON pulsos_jovens(data_aplicacao);
```

2. **Usar pagina√ß√£o**: Limitar resultados a 50-100 por p√°gina
3. **Cache**: Implementar cache de m√©tricas agregadas

---

### Job timeout (> 5min)

**Sintoma:** Job no Inngest fica "Running" por muito tempo e eventualmente falha com timeout.

**Diagn√≥stico:**

Inngest > Runs > Ver dura√ß√£o e logs

Identificar qual step est√° demorando:
- Leitura do banco?
- Envio de emails?
- Processamento de dados?

**Solu√ß√µes:**

| Causa | Solu√ß√£o |
|-------|---------|
| Muitos emails de uma vez | Implementar batching (50-100 por vez) |
| Query lenta | Otimizar query, adicionar √≠ndice |
| API externa lenta (Resend) | Aumentar timeout, implementar retry |
| Loop infinito | Bug, corrigir c√≥digo |

---

## Problemas de Dados

### Dados duplicados

**Sintoma:** Talento tem 2+ pulsos do mesmo n√∫mero.

**Diagn√≥stico:**

```sql
SELECT jovem_id, pulso, COUNT(*)
FROM pulsos_jovens
GROUP BY jovem_id, pulso
HAVING COUNT(*) > 1;
```

**Solu√ß√£o:**

1. **Identificar correto**: Qual pulso manter? (mais recente? com respostas?)
2. **Deletar duplicatas**:

```sql
DELETE FROM pulsos_jovens
WHERE id IN (
  SELECT id FROM (
    SELECT id,
      ROW_NUMBER() OVER (PARTITION BY jovem_id, pulso ORDER BY created_at DESC) as rn
    FROM pulsos_jovens
  ) t
  WHERE rn > 1
);
```

3. **Prevenir recorr√™ncia**: Adicionar constraint unique:

```sql
CREATE UNIQUE INDEX idx_pulsos_jovens_unique
ON pulsos_jovens(jovem_id, pulso);
```

---

### Respostas perdidas

**Sintoma:** Talento diz que respondeu, mas n√£o h√° registro no banco.

**Diagn√≥stico:**

<Steps>
  <Step title="Verificar hist√≥rico">
    ```sql
    SELECT * FROM pulsos_jovens
    WHERE jovem_id = 789
      AND pulso = 3
    ORDER BY updated_at DESC;
    ```
  </Step>
  
  <Step title="Verificar logs de API">
    Buscar logs da requisi√ß√£o POST/PATCH no momento que usu√°rio diz ter enviado
  </Step>
  
  <Step title="Verificar transa√ß√µes">
    Se houve rollback de transa√ß√£o, dados podem ter sido perdidos
  </Step>
</Steps>

**Poss√≠veis Causas:**

- Timeout durante submit (usu√°rio n√£o viu confirma√ß√£o)
- Erro de valida√ß√£o (formul√°rio n√£o enviou)
- Bug no c√≥digo (dados n√£o foram salvos)
- Usu√°rio lembra errado (realmente enviou?)

**Solu√ß√£o:**

Caso confirmado que dados foram perdidos:

1. Reabrir pulso para o talento
2. Pedir que responda novamente
3. Investigar logs para entender causa raiz
4. Implementar logging mais detalhado

---

## Logs e Monitoramento

### Onde Encontrar Logs

| Sistema | URL | O que ver |
|---------|-----|-----------|
| **Inngest** | app.inngest.com | Jobs, eventos, erros |
| **Resend** | resend.com/emails | Envio de emails |
| **Supabase** | app.supabase.com | Queries, slow queries |
| **Directus** | backoffice.leapy.com/admin/settings/activity-log | A√ß√µes de usu√°rios |

### Filtros √öteis

**Inngest:**
- Function = `createPulsosJovens`
- Status = `failed`
- Date range = √∫ltimas 24h

**Supabase Slow Queries:**
- Duration > 5s
- Table = `pulsos_jovens`

---

## Contato de Emerg√™ncia

Para problemas cr√≠ticos que n√£o consegue resolver:

<CardGroup cols={2}>
  <Card title="Time de Dev" icon="code">
    Slack: #eng-pulsos  
    Email: dev@leapy.com
  </Card>
  <Card title="Suporte Infraestrutura" icon="server">
    Slack: #infra  
    Email: infra@leapy.com
  </Card>
</CardGroup>

**Quando escalar:**

- üö® Sistema totalmente fora do ar (> 30min)
- üö® Perda de dados confirmada
- üö® Bug cr√≠tico afetando > 100 usu√°rios
- üö® Job cr√≠tico falhando repetidamente

---

## Pr√≥ximos Passos

<CardGroup cols={2}>
  <Card title="Opera√ß√µes" icon="gears" href="/guides/backoffice/pulsos-operacoes">
    Guia operacional completo
  </Card>
  <Card title="Jobs Inngest" icon="gear" href="/documentation/domains/pulses/jobs-inngest">
    Detalhes t√©cnicos dos jobs
  </Card>
  <Card title="API Reference" icon="code" href="/api-reference/backoffice/pulsos-jovens">
    Documenta√ß√£o de API
  </Card>
  <Card title="Modelo de Dados" icon="database" href="/documentation/domains/pulses/data-model">
    Estrutura do banco
  </Card>
</CardGroup>
